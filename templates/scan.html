<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>API Barcode Scanner</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:12px}
  .wrap{max-width:560px;margin:0 auto}
  video{width:100%;border-radius:12px;background:#000}
  canvas{display:none}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  button,input[type=file]{padding:10px 12px;border:1px solid #ccc;border-radius:10px;background:#f7f7f7;cursor:pointer}
  #status{font-size:12px;color:#666}
  #result{margin-top:10px;padding:10px;border-radius:10px;background:#eef9ee;border:1px solid #cde8cd;word-break:break-word}
</style>
</head>
<body>
<div class="wrap">
  <h2>API Barcode Scanner (Cloudmersive)</h2>
  <video id="video" playsinline muted></video>

  <div class="row">
    <button id="startBtn">Start Camera</button>
    <button id="snapBtn" disabled>Scan (Snapshot)</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div class="row">
    <input id="fileInput" type="file" accept="image/*" capture="environment">
    <button id="scanPhotoBtn">Scan Photo</button>
  </div>

  <div id="status">Idle</div>
  <div id="result" style="display:none"></div>

  <canvas id="scratch"></canvas>
</div>

<script>
(async () => {
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const snapBtn  = document.getElementById('snapBtn');
  const fileInput= document.getElementById('fileInput');
  const scanPhotoBtn = document.getElementById('scanPhotoBtn');
  const statusEl = document.getElementById('status');
  const resultEl = document.getElementById('result');
  const scratch  = document.getElementById('scratch');

  let stream = null;
  let busy = false;

  function setStatus(s){ statusEl.textContent = s; }
  function showResult(items){
    if (!items || !items.length){
      resultEl.style.display='block';
      resultEl.textContent = 'No barcode found.';
      return;
    }
    const lines = items.map(i => `${i.type || 'Unknown'} → ${i.text || ''}`);
    resultEl.style.display='block';
    resultEl.textContent = lines.join('\n');
  }

  async function startCam(){
    await stopCam();
    setStatus('Starting camera…');
    stream = await navigator.mediaDevices.getUserMedia({
      audio:false,
      video:{ facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080} }
    });
    video.srcObject = stream;
    await video.play();
    startBtn.disabled = true; stopBtn.disabled = false; snapBtn.disabled = false;
    setStatus('Ready. Aim barcode in view, then press Scan.');
  }

  async function stopCam(){
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    startBtn.disabled = false; stopBtn.disabled = true; snapBtn.disabled = true;
  }

  function captureToBlob(){
    const vw = video.videoWidth || 1280, vh = video.videoHeight || 720;
    // center ROI (speeds up + clearer for small codes)
    const roi = { x: vw*0.10, y: vh*0.25, w: vw*0.80, h: vh*0.50 };
    const maxW = 1280, scale = Math.min(1, maxW/roi.w);
    scratch.width = Math.round(roi.w*scale);
    scratch.height= Math.round(roi.h*scale);
    const ctx = scratch.getContext('2d', { willReadFrequently: true });
    ctx.drawImage(video, roi.x, roi.y, roi.w, roi.h, 0, 0, scratch.width, scratch.height);
    return new Promise(res => scratch.toBlob(b => res(b), 'image/jpeg', 0.9));
  }

  async function sendToAPI(blob){
    if (busy) return;
    busy = true;
    setStatus('Uploading to API…');
    resultEl.style.display='none';

    const fd = new FormData();
    fd.append('image', blob, 'frame.jpg');

    try{
      const r = await fetch('/api/decode', { method:'POST', body: fd });
      const data = await r.json();
      if (!data.ok){ throw new Error(data.error || 'Decode failed'); }
      showResult(data.results);
      setStatus('Done ✔');
    }catch(e){
      setStatus('Error: ' + e.message);
      resultEl.style.display='block';
      resultEl.textContent = 'API error. Try again or use a clearer image.';
    }finally{
      busy = false;
    }
  }

  startBtn.addEventListener('click', startCam);
  stopBtn .addEventListener('click', stopCam);

  snapBtn.addEventListener('click', async () => {
    if (!stream) return;
    const blob = await captureToBlob();
    await sendToAPI(blob);
  });

  scanPhotoBtn.addEventListener('click', async () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f){ alert('Choose an image first.'); return; }
    await sendToAPI(f);
  });

  // iOS autoplay helper
  document.addEventListener('touchstart', () => { if (video.paused) video.play().catch(()=>{}); }, { once:true });
})();
</script>
</body>
</html>
